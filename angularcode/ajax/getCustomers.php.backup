<?php 
 session_start(); 

 $teste = $_GET['valor'];

 if($teste != ''){

 $dataInicio  = $_GET['dataInicio'];
 $dataFinal = $_GET['dataFinal'];
 $ramal = $_GET['ramal1'];
 $valor = $_GET['valor'];
 $tipo = $_GET['tipo1'];
 
 $_SESSION['dataInicio'] = $dataInicio;
 $_SESSION['dataFinal'] = $dataFinal;
 $_SESSION['ramal'] = $ramal;
 $_SESSION['valor'] = $valor;
 $_SESSION['tipo1'] = $tipo;

 Header ("location: ../index.php");

}else{

 $a = $_SESSION['dataInicio'];
 $b = $_SESSION['dataFinal'];
 $c = $_SESSION['ramal'];
 $d = $_SESSION['valor'];
 $e = $_SESSION['tipo1'];

$DB_HOST = '127.0.0.1';
$DB_USER = 'root';
$DB_PASS = '';
$DB_NAME = 'asteriskcdrdb';
$mysqli = new mysqli($DB_HOST, $DB_USER, $DB_PASS, $DB_NAME);


if ($e == '1')
{
$query="select distinct src, dst, calldate, billsec, (billsec * $d) as total from cdr where calldate >= '$a 00:00:00' and calldate <= '$b 23:59:59' and src = $c and dst > 6000 and (select substring(dst,1,1)) < 5 and (select length(dst) as numero2) = 8 and disposition = 'ANSWERED' order by calldate";
}

else if ($e == '2')
{
$query="select distinct src, dst, calldate, billsec, (billsec * $d) as total from cdr where calldate >= '$a 00:00:00' and calldate <= '$b 23:59:59' and src = $c and dst > 6000 and (select substring(dst,3,1)) BETWEEN 1 AND 5 and (select length(dst) as numero2) = 10 and disposition = 'ANSWERED' union select distinct src, dst, calldate, billsec, (billsec * $d) as total from cdr where calldate >= '$a 00:00:00' and calldate <= '$b 23:59:59' and src = $c and dst > 6000 and (select substring(dst,4,1)) BETWEEN 1 AND 5 and (select length(dst) as numero2) = 11 and disposition = 'ANSWERED' union select distinct src, dst, calldate, billsec, (billsec * $d) as total from cdr where calldate >= '$a 00:00:00' and calldate <= '$b 23:59:59' and src = $c and dst > 6000 and (select substring(dst,6,1)) BETWEEN 1 AND 5 and (select length(dst) as numero2) = 13 and disposition = 'ANSWERED' order by calldate";
}

else if ($e == '3')
{
$query="select distinct src, dst, calldate, billsec, (billsec * $d) as total from cdr where calldate >= '$a 00:00:00' and calldate <= '$b 23:59:59' and src = $c and dst > 6000 and (select substring(dst,1,1)) > 6 and (select length(dst) as numero2) = 8 and disposition = 'ANSWERED' union select distinct src, dst, calldate, billsec, (billsec * $d) as total from cdr where calldate >= '$a 00:00:00' and calldate <= '$b 23:59:59' and src = $c and dst > 6000 and (select substring(dst,4,1)) > 7 and (select length(dst) as numero2) = 11 and disposition = 'ANSWERED' union select distinct src, dst, calldate, billsec, (billsec * $d) as total from cdr where calldate >= '$a 00:00:00' and calldate <= '$b 23:59:59' and src = $c and dst > 6000 and (select substring(dst,3,1)) > 7 and (select length(dst) as numero2) = 10 and disposition = 'ANSWERED union select distinct src, dst, calldate, billsec, (billsec * $d) as total from cdr where calldate >= '$a 00:00:00' and calldate <= '$b 23:59:59' and src = $c and dst > 6000 and (select substring(dst,6,1)) > 7 and (select length(dst) as numero2) = 13 and disposition = 'ANSWERED group by calldate";
}

$result = $mysqli->query($query) or die($mysqli->error.__LINE__);

$arr = array();
if($result->num_rows > 0) {
	while($row = $result->fetch_assoc()) {
		$arr[] = $row;	
	}
}
# JSON-encode the response
$json_response = json_encode($arr);

// # Return the response
echo $json_response;
}        	
?>
